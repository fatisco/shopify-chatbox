<!DOCTYPE html>
<html>
<head>
<title>Customer Chat</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; }
.chat-container { max-width:600px; margin:0 auto; display:flex; flex-direction:column; height:100vh; border:1px solid #ddd; border-radius:10px; overflow:hidden; background:#fff; }
.chat-header { background:#000; color:#fff; padding:15px; text-align:center; font-size:18px; }
.chat-messages { flex:1; padding:10px; overflow-y:auto; }
.chat-message { margin:5px 0; padding:8px 12px; border-radius:12px; display:inline-block; max-width:fit-content; word-wrap:break-word; }
.customer { background:#000; color:#fff; margin-left:auto; }
.admin { background:#f1f0f0; color:#000; margin-right:auto; }
.chat-input { display:flex; padding:10px; border-top:1px solid #ddd; background:#fff; }
.chat-input input { flex:1; padding:12px; border:1px solid #ccc; border-radius:20px; outline:none; }
.chat-input button { margin-left:8px; padding:12px 20px; border:none; border-radius:20px; background:#000; color:#fff; cursor:pointer; }
</style>
</head>
<body>
<div class="chat-container">
  <div class="chat-header">Shopify Customer Support</div>
  <div class="chat-messages" id="messages"></div>
  <div class="chat-input">
    <input id="messageInput" placeholder="Type a message...">
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
const socket = io();
const customer_id = "{{ customer_id }}";
const messagesDiv = document.getElementById("messages");
const input = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

socket.emit("join", { room: customer_id, user_type:"customer" });

function renderMessage(msg){
  const div=document.createElement("div");
  div.classList.add("chat-message", msg.sender==="admin"?"admin":"customer");
  div.innerText=msg.message;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

sendBtn.addEventListener("click", ()=>{
  const msg=input.value.trim();
  if(!msg) return;
  socket.emit("send_message",{room:customer_id, sender:"customer", message:msg});
  renderMessage({message:msg, sender:"customer"});
  input.value="";
});

input.addEventListener("keypress", e=>{ if(e.key==="Enter") sendBtn.click(); });

socket.on("load_history", data=>{
  messagesDiv.innerHTML="";
  data.forEach(msg=>renderMessage(msg));
});

socket.on("receive_message", data=>{
  if(data.room!==customer_id) return;
  renderMessage(data);
});
</script>
</body>
</html>
